<html>
<head>
  {% load staticfiles %}
  <link rel="stylesheet" type="text/css" href="/static/story.css">
  <script src="https://fb.me/react-0.12.0.js"></script>
  <script src="https://fb.me/JSXTransformer-0.12.0.js"></script>
  <script type="text/jsx" src="{% static "SingleHNStory.jsx" %}"></script>
<script type="text/jsx">
/** @jsx React.DOM */
var allTopStories = {{ allStories }};
var hnprojapp = hnprojapp || {};
function monthToStr(month) {
  switch (month) {
    case 0:
      return "Jan"; break;
    case 1:
      return "Feb"; break;
    case 2:
      return "Mar"; break;
    case 3:
      return "Apr"; break;
    case 4:
      return "May"; break;
    case 5:
      return "June"; break;
    case 6:
      return "July"; break;
    case 7:
      return "Aug"; break;
    case 8:
      return "Sept"; break;
    case 9:
      return "Oct"; break;
    case 10:
      return "Nov"; break;
    case 11:
      return "Dec"; break;
  }
  return "";
}
var SingleStory = React.createClass({
  render: function() {
    var url = this.props.story["url"];
    var time = this.props.story["time"] * 1000;
    var storyDate = new Date(time);
    var month = storyDate.getMonth();
    var datestr = monthToStr(month) + " " + storyDate.getDate() + ", " + storyDate.getFullYear();
    var username = "";
    if (this.props.showUser) {
      var userurl = 'https://news.ycombinator.com/user?id=' + this.props.story["by"];
      username = <a className="usernameLink" href={userurl}>{this.props.story["by"]}</a>;
    }
    var itemurl = 'https://news.ycombinator.com/item?id=' + this.props.story["id"];
    var scoreLink = <span className="score">
       <a href={itemurl}>{this.props.story.score}</a></span>;
    return (
      <div className="singleStoryDiv">
        {scoreLink}
        <a href={url}>{this.props.story["title"]}</a> 
        <span className="storyDate">{datestr}</span>
        <span className="username">{username}</span>
      </div>
    );
  }
});
var AllStories = React.createClass({
  render: function() {
    var elems = [];
    for (var i = 0; i < this.props.stories.length; i++) {
      elems.push(<SingleStory showUser={true} story={this.props.stories[i]} />);
    }
    return (<div>{elems}</div>);
  }
});

var AllStoriesByDate = React.createClass({
  getDisplayDate: function(story) {
    return datestr;

  },

  render: function() {
    // split by date
    var byDate = {};
    var elems = [];
    elems.push(<h3>By date</h3>);
    var numStories = this.props.stories.length;
    var daySecs = 24*60*60;
    for (var i = 0; i < numStories; i++) {
      var story = this.props.stories[i];
      var timeDate = story["time"] * 1000;
      timeDate = timeDate - (timeDate % (daySecs * 1000)) + 5;
      if (!(timeDate in byDate)) {
        byDate[timeDate] = [];
      }
      byDate[timeDate].push(story)
    }
    var keys = Object.keys(byDate);
    keys.sort();
    keys.reverse();
    for (var j = 0; j < keys.length; j++) {
      var currDate = keys[j];
      var timeDate = new Date(currDate);
      var month = timeDate.getMonth();
      console.log("date: " + currDate + ": " + timeDate + ":" + month);
      var datestr = monthToStr(month) + " " + timeDate.getDate() + ", " + timeDate.getFullYear();
      var dateStories = byDate[currDate];
      elems.push(<div><h3>{datestr}</h3><AllStories stories={dateStories}/></div>);
    }
    return (<div>{elems}</div>);
  }
});

React.renderComponent(
  <AllStoriesByDate stories={allTopStories}/>,
  document.getElementById("topStories"));
var topInSources = {{ top_urls }};
React.renderComponent(
  <AllStories stories={topInSources}/>,
  document.getElementById("topSources"));
</script>
</head>
<body>
<h2>Top Stories</h2>
<div id="topSources"></div>
<h4>All other top stories</h4>
<div id="topStories"></div>
</body>
</html>
